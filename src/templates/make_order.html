{% extends 'base.html' %}
{% load thumbnail %}

{% block page-title %}
    Оформление Заказа
{% endblock %}

{% block content %}
    <section class="ls s-py-80 s-py-md-120 s-py-xl-160">
        <div class="container">
            <div class="row">

                <main class="col-lg-12">
                    <article id="post-1707" class="post-1707 page type-page status-publish hentry">
                        {% if is_empty %}
                        Заказ пуст
                        {% else %}
                        <main class="col-lg-12">

                            <table class="shop_table shop_table_responsive cart">
                                <thead>
                                <tr>
                                    <th class="product-thumbnail">&nbsp;</th>
                                    <th class="product-name">Название</th>
                                    <th class="product-price">Цена</th>
                                    <th class="product-quantity">Количество</th>
                                    <th class="product-subtotal">Всего</th>
                                </tr>
                                </thead>
                                <tbody>

                                {% for product_cart in order_items %}


                                    <tr class="cart_item">

                                        {#                            <td class="product-remove">#}
                                        {#                                <a href="{% url 'remove_cart_item' item_id=product_cart.id %}"#}
                                        {#                                   class="remove-btn"#}
                                        {#                                           aria-label="Remove this item" #}
                                        {#                                           data-product_id="73"#}
                                        {#                                           data-product_sku=""#}
                                        {#                                >×</a>#}
                                        {#                            </td>#}
                                        <td class="product-thumbnail">
                                            {% for image in product_cart.product.images.all %}
                                                <a href="{% url 'detail' pk=product_cart.product.id %}">
                                                    <img width="180" height="180"
                                                         src="{% thumbnail image.image 900x900 %}"
                                                         class="" alt="img">
                                                </a>
                                            {% endfor %}
                                        </td>

                                        <td class="product-name" data-title="Product">
                                            <a href="{% url 'detail' pk=product_cart.product.id %}">{{ product_cart.product.name }}</a>
                                        </td>

                                        <td class="product-price" data-title="Price">
												<span class="amount">
													<span>₽ </span>{{ product_cart.product.price }}
												</span>
                                        </td>

                                        <td class="product-subtotal" data-title="Total">
												<span class="amount">
													<span> </span>{{ product_cart.quantity }}
												</span>
                                        </td>
                                        <td class="product-subtotal" data-title="Total">
												<span class="amount">
													<span>₽ </span>{{ product_cart.total_price }}
												</span>
                                        </td>
                                    </tr>
                                {% endfor %}

                                </tbody>
                            </table>
                            {#                        </form>#}
                        </main>
                        <hr>
                        <div class="row pt-4">
                            <div class="col-md-6">
                                <div id="ecom-widget" style="height: 400px; width: 500px"></div>
                                <p>Укажите адрес доставки</p>
                            </div>
                            <div class="col-md-6">
                                <h6>Стоимость заказа: {{ total_sum }}р</h6>
                                <h6>Стоимость доставки: <span id="delivery-cost"></span>р
                                    {% if not delivery_cost %}
                                        <span style="color: red" id="address-error"><br>Не указан адрес доставки</span>
                                    {% endif %}
                                </h6>
                                <h6>ИТОГО: <span id="total"></span>р</h6>
                                {#                            {% if delivery_cost != 0 %}#}
                                <form action="{% url 'make_order_submit' %}" method="post">
                                    {% csrf_token %}
                                    <div class="wc-proceed-to-checkout">
                                      <input type="text" id="first-name" name="first_name" placeholder="First Name">
                                      <input type="text" id="last-name" name="last_name" placeholder="Last Name">
                                        <button type="submit" class="btn btn-outline-maincolor mt-30"
                                                id="submit-btn"
                                                name="pay" {% if not delivery_cost %}disabled="disabled"{% endif %}>
                                            Оплатить
                                        </button>
                                    </div>
                                </form>
{#                                <form id="order-form">#}
{#                                  <input type="text" id="first-name" name="first_name" placeholder="First Name">#}
{#                                  <input type="text" id="last-name" name="last_name" placeholder="Last Name">#}
{#                                  <!-- Other form inputs -->#}
{#                                  <button type="submit">Submit</button>#}
{#                                </form>#}
                            </div>
                        </div>
                    {% endif %}
                    </article>
                </main>
            </div>
        </div>
    </section>

{% endblock %}

{% block head %}

    <script src="https://widget.pochta.ru/map/widget/widget.js"></script>
{#                        {% endif %}#}

{% endblock %}

{% block scripts %}
    <script>
    document.getElementById("order-form").addEventListener("submit", function(event) {
      event.preventDefault(); // Prevent form submission

      // Get form input values
      var firstName = document.getElementById("first-name").value;
      var lastName = document.getElementById("last-name").value;
      // Get other form input values

      // Create JSON object
      var orderData = {
        "first_name": firstName,
        "last_name": lastName,
        // Add other form input values to the JSON object
      };

      // Convert JSON object to string
      var jsonData = JSON.stringify(orderData);

      // Send jsonData to the Russian Post widget or save it to a file
    });
    </script>
    <script>
        // Получаем кнопку и всплывающее окно по их идентификаторам
        var button = document.getElementById("myButton");
        var modal = document.getElementById("myModal");

        // Добавляем обработчик события при клике на кнопку
        button.addEventListener("click", function () {
            // Отображаем всплывающее окно, установив его стилю display в "block"
            modal.style.display = "block";
        });
    </script>
    <script>

        let total_sum = {{ total_sum }};
        let delivery_cost = {{delivery_cost}};
        var firstName = document.getElementById("first-name").value;
        var lastName = document.getElementById("last-name").value;
        var orderData = {
          "first_name": firstName,
          "last_name": lastName,
          // Add other form input values to the JSON object
            };


        function set_address(data) {
            data['more_info'] = {'name': orderData.first_name, 'surname':orderData.last_name}
            console.log(orderData)
            let d = window.btoa(unescape(encodeURIComponent(JSON.stringify(data))))
            $.ajax({
                url: '{% url 'update_cart' %}',
                type: 'POST',
                data: {
                    delivery_info: d,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                dataType: 'text',
                success: function (result) {
                    {#alert(result.Result);#}
                }
            });

            delivery_cost = Math.floor(data.cashOfDelivery / 100);
            compute_total()
            $('#submit-btn').prop('disabled', false)
            $('#address-error').hide()
        }

        function compute_total() {
            let total = total_sum + delivery_cost;
            console.log(total)
            $("#delivery-cost").html(delivery_cost)
            $("#total").html(total)
        }

        $(document).ready(() => {
            ecomStartWidget({
                id: 45145,
                callbackFunction: set_address,
                containerId: 'ecom-widget'
            });
            compute_total()
        })
    </script>
{% endblock %}